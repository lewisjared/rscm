# Documenting Components

This guide explains how to write documentation for RSCM components so they appear correctly in the generated documentation site.

## Overview

Component documentation is generated from two sources:

- **Rust components**: JSON metadata files in `docs/component_metadata/`, generated by the `rscm-doc-gen` crate which parses Rust source files
- **Python components**: Extracted from the `Component` class registry via docstrings and type annotations

The `docs/gen_doc_stubs.py` script combines both sources and generates markdown pages for each component.

## Rust Components

### Docstrings

Write documentation in the Rust docstring (`///` comments) above the component struct. The full docstring appears in the "Description" section of the generated page.

```rust
/// CO2 effective radiative forcing component
///
/// Computes ERF using the standard logarithmic relationship:
///
/// $$
/// ERF = \frac{ERF_{2 \times CO_2}}{\ln(2)} \cdot \ln\left(\frac{C}{C_0}\right)
/// $$
///
/// where:
///
/// - $C$ is the current atmospheric CO2 concentration
/// - $C_0$ is the pre-industrial concentration
/// - $ERF_{2 \times CO_2}$ is the forcing from a doubling of CO2
#[derive(Debug, Serialize, Deserialize, ComponentIO)]
#[inputs(
    concentration { name = "Atmospheric Concentration|CO2", unit = "ppm" },
)]
#[outputs(
    erf { name = "Effective Radiative Forcing|CO2", unit = "W / m^2" },
)]
pub struct CO2ERF {
    parameters: CO2ERFParameters,
}
```

### Equations

Use KaTeX syntax for mathematical equations:

- **Inline**: `$x^2$` renders as $x^2$
- **Block**: Use `$$` delimiters on separate lines for display equations

The documentation site renders KaTeX automatically.

### Component Metadata Schema

The `rscm-doc-gen` crate generates JSON files with this structure:

```json
{
  "$schema": "component_metadata_schema.json",
  "name": "TwoLayer",
  "module_path": "rscm_two_layer::component",
  "language": "rust",
  "description": "Docstring content here...",
  "category": "Temperature",
  "tags": ["temperature", "ocean", "two-layer", "stable"],
  "inputs": [
    {
      "rust_name": "erf",
      "variable_name": "Effective Radiative Forcing",
      "unit": "W/m^2",
      "grid": "Scalar"
    }
  ],
  "outputs": [
    {
      "rust_name": "surface_temperature",
      "variable_name": "Surface Temperature",
      "unit": "K",
      "grid": "Scalar"
    }
  ],
  "states": [],
  "parameters": [
    {
      "name": "lambda0",
      "type": "FloatValue",
      "description": "Parameter description from doc comment"
    }
  ],
  "source_file": "crates/rscm-two-layer/src/component.rs"
}
```

### Generating Metadata

Run the doc-gen tool to update metadata files:

```bash
cargo run -p rscm-doc-gen
```

This parses all component source files and writes JSON to `docs/component_metadata/`.

### Category and Tags

Set the category and tags in the JSON metadata to help users find related components:

| Category     | Description                              |
| ------------ | ---------------------------------------- |
| Temperature  | Components computing temperature changes |
| Carbon Cycle | CO2 emissions, concentrations, uptake    |
| Forcing      | Radiative forcing calculations           |
| Ocean        | Ocean heat uptake, carbon, dynamics      |
| Other        | Miscellaneous components                 |

Common tags: `stable`, `experimental`, `carbon`, `temperature`, `forcing`, `ocean`, `land`

## Python Components

### Docstrings

For Python components, documentation is extracted from the class docstring. Place equations and descriptions directly in the docstring:

```python
class SimpleEmissionsToConcentration(Component):
    """
    Simple emissions to concentration component.

    Converts CO2 emissions to atmospheric concentration changes using
    a linear airborne fraction model:

    $$
    C(t) = C(t-1) + \\alpha \\cdot E(t) \\cdot \\frac{M_{CO2}}{M_C}
    $$

    where $\\alpha$ is the airborne fraction (fraction of emissions
    remaining in the atmosphere).

    Parameters
    ----------
    airborne_fraction
        Fraction of emissions remaining in atmosphere (typically ~0.45)
    gtc_to_ppm
        Conversion factor from GtC to ppm (~0.47 ppm/GtC)
    """

    emissions = Input("Emissions|CO2", unit="GtCO2")
    concentration = State("Atmospheric Concentration|CO2", unit="ppm")

    def __init__(self, airborne_fraction: float, gtc_to_ppm: float):
        self.airborne_fraction = airborne_fraction
        self.gtc_to_ppm = gtc_to_ppm
```

### Registration

Python components are automatically registered when their class is defined. To exclude a component from documentation (e.g., abstract base classes):

```python
class AbstractComponent(Component, register=False):
    """This won't appear in the component index."""
    pass
```

### Parameter Documentation

Document parameters in the `__init__` docstring using numpy-style formatting:

```python
def __init__(self, tau: float, sensitivity: float):
    """
    Parameters
    ----------
    tau
        Time constant for the exponential decay (years)
    sensitivity
        Climate sensitivity parameter (K per W/m^2)
    """
```

## Generated Documentation

Each component page includes:

1. **Header**: Name, category, tags, language
2. **Description**: Full docstring with rendered equations
3. **Inputs table**: Variable name, unit, grid type
4. **Outputs table**: Variable name, unit, grid type
5. **States table**: (if applicable) State variables
6. **Parameters table**: Configuration parameters with types
7. **Usage examples**: Python and Rust code snippets
8. **Source reference**: Link to source file

## Building Documentation

Preview the documentation site locally:

```bash
# Install docs dependencies (first time)
uv pip install -e ".[docs]"

# Serve locally with auto-reload
make docs-serve

# Build static site
make docs
```

The generated component pages appear under `site/components/`.

## Best Practices

### Writing Effective Descriptions

- Start with a one-line summary of what the component does
- Explain the physical/mathematical basis
- Include the governing equations with variable definitions
- Note any assumptions or limitations

### Variable Naming

Follow the hierarchical naming convention:

- `Emissions|CO2` - CO2 emissions
- `Atmospheric Concentration|CO2` - Atmospheric CO2 concentration
- `Effective Radiative Forcing|CO2` - ERF from CO2
- `Surface Temperature` - Global mean surface temperature

### Units

Use standard unit strings that are parseable by `pint`:

- `GtCO2`, `GtC` - Gigatonnes of CO2 or carbon
- `ppm` - Parts per million
- `W/m^2` - Watts per square metre
- `K` - Kelvin
- `yr` - Years

### Equations

- Define all variables used in equations
- Use consistent notation across related components
- Reference literature sources where applicable

### Keeping Documentation Updated

1. Update docstrings when component behaviour changes
2. Re-run `cargo run -p rscm-doc-gen` after modifying Rust components
3. Verify changes with `mkdocs serve` before committing

Note that steps 2 and 3 are performed automatically when running `make docs`
