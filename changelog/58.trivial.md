Fixed clippy warnings and cleaned up legacy code.
